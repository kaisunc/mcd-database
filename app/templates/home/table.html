{% from "./_formhelpers.html" import render_field %}

{% extends "base.html" %}
{% block title %}Projects{% endblock %}

{% block css %}
    <link rel="stylesheet" type="text/css" href="static/lib/DataTables/datatables.min.css"/>
    <link rel="stylesheet" type="text/css" href="static/lib/Editor-1.7.2/css/editor.bootstrap4.min.css">
    <link rel="stylesheet" type="text/css" href="static/lib/DataTables/Select-1.2.5/css/select.bootstrap4.min.css">
    <link rel="stylesheet" type="text/css" href="static/lib/DataTables/Buttons-1.5.1/css/buttons.bootstrap4.min.css">
    <link rel="stylesheet" type="text/css" href="static/lib/dropzone/dropzone.css">
    <link rel="stylesheet" type="text/css" href="static/lib/selectize/css/selectize-bootstrap4.css">
    <link rel="stylesheet" type="text/css" href="static/lib/selectize/css/selectize.css">
{% endblock %}

{% block js %}
  <script src="../static/lib/socket.io.js" type="text/javascript"></script>
  <script src="./static/lib/dropzone/dropzone.js"></script>
  <script src="./static/lib/selectize/js/standalone/selectize.js"></script>

  <script>
    Dropzone.autoDiscover = false;
    var columns = JSON.parse("{{columns}}");    
    var columnDefs = JSON.parse("{{columnDefs}}");
    var fields = JSON.parse("{{fields}}");    
  </script>
  <script type="text/javascript" src="static/lib/DataTables/datatables.min.js"></script>
  <script type="text/javascript" src="static/lib/DataTables/DataTables-1.10.16/js/dataTables.bootstrap4.min.js"></script>
  <script type="text/javascript" src="static/lib/DataTables/Select-1.2.5/js/dataTables.select.min.js"></script>
  <script type="text/javascript" src="static/lib/DataTables/Buttons-1.5.1/js/dataTables.buttons.min.js"></script>
  <script type="text/javascript" src="static/lib/DataTables/Buttons-1.5.1/js/buttons.bootstrap4.min.js"></script>
  <script type="text/javascript" src="static/lib/Editor-1.7.2/js/dataTables.editor.min.js"></script>
  <script type="text/javascript" src="static/lib/Editor-1.7.2/js/editor.bootstrap4.min.js"></script>
  <script type="text/javascript" src="static/js/dt_selectize.js"></script>

{% endblock %}

{% block body %}

{% include "./home/toolbar.html" %}
{% include "./home/dragdrop.html" %}

<table id={{namespace}} class="compact table-striped table-bordered table-hover" cellspacing="0" width="100%">

</table>

{% endblock %}

{% block run_scripts %}
<script>
  var thumbs =[];
  var myDropzone = new Dropzone("#media_drop", {
    url: "{{ url_for('home.upload')}}",
    maxFilesize: 10000, //10GB
    autoProcessQueue: false,
    thumbnailWidth: 120
  });

  function dz_clear(){
    var acceptedFiles = myDropzone.getAcceptedFiles();
    for(i=0; i < acceptedFiles.length; i++){
      myDropzone.removeFile(acceptedFiles[i]);
    };      
  }

  myDropzone.on("addedfile", function(file) {
    image_ext = ["jpg", "jpeg", "bmp", "tif", "tiff", "tga", "png", "psd", "gif", "svg", "ai", "eps"];
    video_ext = ["mp4", "avi", "wmv", "mov", "qt", "mkv", "ts", "webm", "flv", "rmvb"];
    audio_ext = ["mp3", "wmv", "pcm", "aiff", "aac", "ogg", "wma", "flac", "alac"];
    font_ext = ["ttf", "otf", "eot", "woff", "svg", "woff2"];
    file_ext = ["exe", "zip", "rar"];

    ext = file.name.split('.').pop()
    if(image_ext.indexOf(ext) > -1){
      $("#select_category").text("images");
      $("#select_category").attr("value", 3);
    } else if(audio_ext.indexOf(ext) > -1){
      $("#select_category").text("sfx");
      $("#select_category").attr("value", 7);
    } else if(video_ext.indexOf(ext) > -1){
      $("#select_category").text("videos");
      $("#select_category").attr("value", 15);
    } else if(file_ext.indexOf(ext) > -1){
      $("#select_category").text("software");
      $("#select_category").attr("value", 2);
    } else if(font_ext.indexOf(ext) > -1){
      $("#select_category").text("fonts");
      $("#select_category").attr("value", 1);
    } else {
      $("#select_category").text("software");
      $("#select_category").attr("value", 2);      
    }
  });

  myDropzone.on("thumbnail", function(file, dataUri) {
    t = [file, dataUri];
    thumbs.push(t);
  });

  var editor;
  var table;
  var socket;
  var select;
  var category;
  var output;
  var columns;
  var fields;

  $(document).ready(function() {
    namespace = "{{namespace}}";
    socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port);
    render =  function ( data, meta, row ) {return data.label;};
    thumb_render = function ( data, meta, row ) {
      var id = ("00000000" + row['id']).substr(-8,8);
      var url = "http://" + window.location.hostname + "/download/" + row['category']['label'] + "/" + id + "/" + row['name'];

      return '<a href="' + url +'" download><img class="thumbs" src="'+data+'"/></a>';
    };

    for(i=0;i<columns.length;i++){
      if(columns[i]['render'] == 'render'){
        columns[i]['render'] = render;
      };
      if(columns[i]['render'] == 'thumb_render'){
        columns[i]['render'] = thumb_render;
      };
    };    

    table = $('#' + namespace).DataTable( {
        "dom": '<"top"p>t<"bottom"ip><"clear">',
        "pageLength": 20,
        "processing": true,
        "serverSide": true,
        "ajax": function (data, callback, settings) {
                  socket.emit('ajax_socket', {'namespace': namespace, 'settings':data, 'columns': columns, 'fields': fields, 'columnDefs': columnDefs});
                  socket.on('init_response', function(response){
                    output = JSON.parse(response);
                    callback(output);  
                  })
                },
        "rowId": 'id',
        "columns": columns,        
        "columnDefs": columnDefs,      
        "order": [[ 1, "desc" ]],        
        "select": {
            "style": 'os',
            "selector": 'td:first-child'
        }
    });      

    editor = new $.fn.dataTable.Editor( {
        data: output,
        ajax: function ( method, url, d, successCallback, errorCallback ) {
          var output = { data: [] };
          for(var k in d.data); //get the id

          if ( d.action === 'create' ) {
            socket.emit('create', {'namespace': namespace, 'data': d.data[k], 'multiple': 'false'});
          }
          else if ( d.action === 'edit' ) {
            socket.emit('update', {'namespace': namespace, 'id': k, 'data':d.data[k]});
          }
          else if ( d.action === 'remove' ) {
            var k = [];
            $.each( d.data, function (id) {
              k.push(id);
            } );
            socket.emit('remove', {'namespace': namespace, 'ids': k});
          }
          successCallback(output);
        },
        table: '#' + namespace,
        idSrc:  'id',
        fields: fields
    } );   

    $('#' + namespace).on( 'click', 'tbody td:not(:first-child)', function (e) {
      var category = $(this).text();

      editor.inline( this, {
        drawType: 'page',
        onBlur: 'submit',
        onReturn: 'submit',
        submit: 'changed'
      } );

      $("div.DTE_Field_InputControl select option:contains('" + category + "')").attr("selected", "selected");
      $("div.DTE_Field_InputControl select option:contains('" + category + "')").prop("selected", "selected");
    } ); 

    // upload using request AFTER db inserts data
    socket.on('add_response', function(msg) {
      data = JSON.parse(msg["data"]);
      category = data['category']['label'];
      file_id = data['id'];
      file_name = data['name'];

      myDropzone.options.url = "upload?category=" + category + "&file_id=" + file_id;
      for(i=0;i<myDropzone.files.length;i++){
        if(myDropzone.files[i].name == file_name){
          myDropzone.processFile(myDropzone.files[i]);      
          table.row.add(data).draw();
        }
      }
    })

    socket.on('update_response', function(msg) {
      d = JSON.parse(msg.data);
      table.row.add(d).draw('page');
    })

    socket.on('delete_response', function(msg) {
      data = JSON.parse(msg['ids']);
      for(i=0;i<data.length;i++){
        id = data[i];
        table.row('#' + parseInt(id)).remove().draw();
      }
    })

    $('.table-len').on("click", function(event){
      var length = $(this).attr('value')
      table.page.len(length).draw();
    });

    $('.table-search').on( 'keyup', function () {
      table.search( this.value ).draw();
    } );  

    $( ".dt_add" ).bind({
      click: function() {
        if(namespace == 'media'){
          if($("#media_drop").css("display") == "block"){
            $('#media_drop').css("display", "none");
            $('#dz-toolbar').css("display", "none");
            $('#dt-toolbar').css("display", "block");
            $('#media_wrapper').css("display", "block");

          } else if($("#media_drop").css("display") == "none"){ //open dropzone and dz toolbar
            $('#media_drop').css("display", "block");
            $('#dz-toolbar').css("display", "block");
            $('#dt-toolbar').css("display", "none");
            $('#media_wrapper').css("display", "none");
          }
        } else if(namespace == 'category'){
          editor.create({
            buttons: 'Create'
          });
        }
      }
    });
    $( ".dt_remove" ).bind({
      click: function() {
        editor
        .title( 'Delete row' )
        .buttons( 'Confirm delete' )
        .message( 'Are you sure you want to remove this row?' )
        .remove(table.rows( { selected: true } ).indexes());
      }
    });

    $( ".dt_edit" ).bind({
      click: function() {
        editor
        .title( 'Update Entry')
        .buttons( 'Update' )
        .edit(table.rows( { selected: true } ).indexes());
      }
    });

    $( ".dz_close" ).bind({
      click: function() {
        if($("#media_drop").css("display") == "block"){
          $('#media_drop').css("display", "none");
          $('#dz-toolbar').css("display", "none");
          $('#dt-toolbar').css("display", "flex");
          $('#media_wrapper').css("display", "block");

        } else if($("#media_drop").css("display") == "none"){ //open dropzone and dz toolbar
          $('#media_drop').css("display", "block");
          $('#dz-toolbar').css("display", "block");
          $('#dt-toolbar').css("display", "none");
          $('#media_wrapper').css("display", "none");
        }
      }
    });

    $( ".dz_add" ).bind({
      click: function() {
        category = parseInt($('#select_category').val());
        user_id = parseInt($('i.fa-user').attr('user-id'));

        tags = selectize.items.join(",");
        acceptedFiles = myDropzone.getAcceptedFiles();

        itemlist = [];
        for(i=0;i<acceptedFiles.length;i++){
          name = acceptedFiles[i]['name'];
          for(j=0;j<thumbs.length;j++){
            if(thumbs[j][0].name == name){
              thumb = thumbs[j][1];
              data = {"name": name, "category": category, "tags": tags, "assigned": user_id, "thumbnail": thumb};
              itemlist.push(data);
            } else {
            }
          }
        }
        socket.emit('create', {'namespace': 'media', 'data': itemlist, 'multiple': 'true'} );
      }
    });


    $( ".dz_clear" ).bind({
      click: function() {
        dz_clear();
      }
    });

    $(".dropdown-menu a").click(function(){
      tt = $(this).parent().parent().find('.dropdown-toggle');
      $(tt).text($(this).text());
      $(tt).attr("value", $(this).attr("value"));
    });

    $select = $('#input-tags').selectize({
      persist: false,
      createOnBlur: true,
      create: true
    });

    selectize = $select[0].selectize;
  });

</script>
{% endblock %}

